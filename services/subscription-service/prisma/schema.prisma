// Subscription Service Database Schema
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ========================================
// SUBSCRIPTION PLANS AND PRICING
// ========================================

model SubscriptionPlan {
  id                String   @id @default(cuid())
  name              String   @unique // "basic", "premium", "pro"
  displayName       String   // "Basic Plan", "Premium Plan", "Pro Plan"
  description       String?
  
  // Pricing
  monthlyPrice      Decimal  @db.Decimal(10,2)
  yearlyPrice       Decimal  @db.Decimal(10,2)
  yearlyDiscount    Int      @default(0) // Percentage discount for yearly
  
  // Plan features
  features          Json     @default("[]") // Array of feature IDs/names
  limits            Json     @default("{}") // Usage limits (matches_per_day, messages_per_day, etc.)
  
  // Plan configuration
  isActive          Boolean  @default(true)
  sortOrder         Int      @default(0)
  stripePriceIdMonthly String? @map("stripe_price_id_monthly")
  stripePriceIdYearly  String? @map("stripe_price_id_yearly")
  
  // Metadata
  createdAt         DateTime @default(now()) @map("created_at")
  updatedAt         DateTime @updatedAt @map("updated_at")
  
  // Relationships
  subscriptions     UserSubscription[]
  analytics         SubscriptionAnalytics[]

  @@map("subscription_plans")
  @@index([isActive])
  @@index([sortOrder])
}

// ========================================
// USER SUBSCRIPTIONS
// ========================================

model UserSubscription {
  id                  String   @id @default(cuid())
  userId              String   @map("user_id")
  planId              String   @map("plan_id")
  
  // Subscription details
  status              SubscriptionStatus @default(ACTIVE)
  billingCycle        BillingCycle @default(MONTHLY)
  
  // Pricing at time of subscription
  currentPrice        Decimal  @db.Decimal(10,2) @map("current_price")
  currency            String   @default("USD")
  
  // Billing dates
  startedAt           DateTime @map("started_at")
  currentPeriodStart  DateTime @map("current_period_start")
  currentPeriodEnd    DateTime @map("current_period_end")
  cancelAt            DateTime? @map("cancel_at")
  canceledAt          DateTime? @map("canceled_at")
  endedAt             DateTime? @map("ended_at")
  
  // Trial information
  trialStart          DateTime? @map("trial_start")
  trialEnd            DateTime? @map("trial_end")
  isTrialActive       Boolean  @default(false) @map("is_trial_active")
  
  // Payment information
  stripeSubscriptionId String? @unique @map("stripe_subscription_id")
  stripeCustomerId    String? @map("stripe_customer_id")
  
  // Cancellation/refund tracking
  cancellationReason  String?  @map("cancellation_reason")
  refundAmount        Decimal? @db.Decimal(10,2) @map("refund_amount")
  refundedAt          DateTime? @map("refunded_at")
  
  // Auto-renewal
  autoRenew           Boolean  @default(true) @map("auto_renew")
  renewalNotifiedAt   DateTime? @map("renewal_notified_at")
  
  // Metadata
  metadata            Json     @default("{}")
  createdAt           DateTime @default(now()) @map("created_at")
  updatedAt           DateTime @updatedAt @map("updated_at")
  
  // Relationships
  plan                SubscriptionPlan @relation(fields: [planId], references: [id])
  invoices            Invoice[]
  payments            Payment[]
  usageEvents         UsageEvent[]
  
  @@map("user_subscriptions")
  @@index([userId])
  @@index([status])
  @@index([planId])
  @@index([currentPeriodEnd])
  @@index([stripeSubscriptionId])
}

// ========================================
// BILLING AND INVOICING
// ========================================

model Invoice {
  id                  String   @id @default(cuid())
  subscriptionId      String   @map("subscription_id")
  userId              String   @map("user_id")
  
  // Invoice details
  invoiceNumber       String   @unique @map("invoice_number")
  status              InvoiceStatus @default(PENDING)
  
  // Amounts
  subtotal            Decimal  @db.Decimal(10,2)
  discountAmount      Decimal  @default(0) @db.Decimal(10,2) @map("discount_amount")
  taxAmount           Decimal  @default(0) @db.Decimal(10,2) @map("tax_amount")
  totalAmount         Decimal  @db.Decimal(10,2) @map("total_amount")
  currency            String   @default("USD")
  
  // Billing period
  periodStart         DateTime @map("period_start")
  periodEnd           DateTime @map("period_end")
  
  // Payment tracking
  dueDate             DateTime @map("due_date")
  paidAt              DateTime? @map("paid_at")
  attemptedAt         DateTime? @map("attempted_at")
  failedAt            DateTime? @map("failed_at")
  
  // Stripe integration
  stripeInvoiceId     String?  @unique @map("stripe_invoice_id")
  stripeChargeId      String?  @map("stripe_charge_id")
  
  // Line items (stored as JSON for flexibility)
  lineItems           Json     @default("[]") @map("line_items")
  
  // Metadata
  metadata            Json     @default("{}")
  createdAt           DateTime @default(now()) @map("created_at")
  updatedAt           DateTime @updatedAt @map("updated_at")
  
  // Relationships
  subscription        UserSubscription @relation(fields: [subscriptionId], references: [id])
  payments            Payment[]
  
  @@map("invoices")
  @@index([userId])
  @@index([status])
  @@index([dueDate])
  @@index([stripeInvoiceId])
}

// ========================================
// PAYMENT PROCESSING
// ========================================

model Payment {
  id                  String   @id @default(cuid())
  subscriptionId      String?  @map("subscription_id")
  invoiceId           String?  @map("invoice_id")
  userId              String   @map("user_id")
  
  // Payment details
  amount              Decimal  @db.Decimal(10,2)
  currency            String   @default("USD")
  status              PaymentStatus @default(PENDING)
  paymentMethod       PaymentMethod @default(CARD)
  
  // Stripe integration
  stripePaymentIntentId String? @unique @map("stripe_payment_intent_id")
  stripeChargeId        String? @map("stripe_charge_id")
  stripeCustomerId      String? @map("stripe_customer_id")
  
  // Payment metadata
  last4               String?  // Last 4 digits of card
  cardBrand           String?  @map("card_brand")
  expiryMonth         Int?     @map("expiry_month")
  expiryYear          Int?     @map("expiry_year")
  
  // Transaction details
  processedAt         DateTime? @map("processed_at")
  failedAt            DateTime? @map("failed_at")
  refundedAt          DateTime? @map("refunded_at")
  refundAmount        Decimal?  @db.Decimal(10,2) @map("refund_amount")
  
  // Failure tracking
  failureCode         String?   @map("failure_code")
  failureMessage      String?   @map("failure_message")
  
  // Metadata
  metadata            Json     @default("{}")
  createdAt           DateTime @default(now()) @map("created_at")
  updatedAt           DateTime @updatedAt @map("updated_at")
  
  // Relationships
  subscription        UserSubscription? @relation(fields: [subscriptionId], references: [id])
  invoice             Invoice?          @relation(fields: [invoiceId], references: [id])
  
  @@map("payments")
  @@index([userId])
  @@index([status])
  @@index([stripePaymentIntentId])
  @@index([processedAt])
}

// ========================================
// CUSTOMER PAYMENT METHODS
// ========================================

model PaymentMethodInfo {
  id                  String   @id @default(cuid())
  userId              String   @map("user_id")
  
  // Stripe payment method
  stripePaymentMethodId String @unique @map("stripe_payment_method_id")
  stripeCustomerId      String @map("stripe_customer_id")
  
  // Card details
  type                String   // "card", "bank_account", etc.
  cardBrand           String?  @map("card_brand")
  cardLast4           String?  @map("card_last4")
  cardExpMonth        Int?     @map("card_exp_month")
  cardExpYear         Int?     @map("card_exp_year")
  
  // Status
  isDefault           Boolean  @default(false) @map("is_default")
  isActive            Boolean  @default(true) @map("is_active")
  
  // Metadata
  billingDetails      Json     @default("{}") @map("billing_details")
  metadata            Json     @default("{}")
  createdAt           DateTime @default(now()) @map("created_at")
  updatedAt           DateTime @updatedAt @map("updated_at")
  
  @@map("payment_methods")
  @@index([userId])
  @@index([stripeCustomerId])
  @@index([isDefault])
}

// ========================================
// USAGE TRACKING AND ANALYTICS
// ========================================

model UsageEvent {
  id                  String   @id @default(cuid())
  subscriptionId      String   @map("subscription_id")
  userId              String   @map("user_id")
  
  // Event details
  eventType           String   @map("event_type") // "match_created", "message_sent", "video_call", etc.
  eventCount          Int      @default(1) @map("event_count")
  
  // Metadata
  metadata            Json     @default("{}")
  recordedAt          DateTime @default(now()) @map("recorded_at")
  
  // Relationships
  subscription        UserSubscription @relation(fields: [subscriptionId], references: [id])
  
  @@map("usage_events")
  @@index([userId])
  @@index([eventType])
  @@index([recordedAt])
}

model SubscriptionAnalytics {
  id                  String   @id @default(cuid())
  date                DateTime @db.Date
  planId              String?  @map("plan_id")
  
  // Subscription metrics
  newSubscriptions    Int      @default(0) @map("new_subscriptions")
  canceledSubscriptions Int    @default(0) @map("canceled_subscriptions")
  activeSubscriptions Int      @default(0) @map("active_subscriptions")
  upgrades            Int      @default(0)
  downgrades          Int      @default(0)
  
  // Revenue metrics
  mrr                 Decimal  @db.Decimal(10,2) @default(0) // Monthly Recurring Revenue
  arr                 Decimal  @db.Decimal(10,2) @default(0) // Annual Recurring Revenue
  totalRevenue        Decimal  @db.Decimal(10,2) @default(0) @map("total_revenue")
  averageRevenue      Decimal  @db.Decimal(10,2) @default(0) @map("average_revenue")
  
  // Churn metrics
  churnRate           Decimal  @db.Decimal(5,4) @default(0) @map("churn_rate")
  retentionRate       Decimal  @db.Decimal(5,4) @default(0) @map("retention_rate")
  
  // Customer metrics
  customerLifetimeValue Decimal @db.Decimal(10,2) @default(0) @map("customer_lifetime_value")
  averageSubscriptionLength Int @default(0) @map("average_subscription_length")
  
  // Trial metrics
  trialConversions    Int      @default(0) @map("trial_conversions")
  trialConversionRate Decimal  @db.Decimal(5,4) @default(0) @map("trial_conversion_rate")
  
  // Metadata
  createdAt           DateTime @default(now()) @map("created_at")
  updatedAt           DateTime @updatedAt @map("updated_at")
  
  // Relationships
  plan                SubscriptionPlan? @relation(fields: [planId], references: [id])
  
  @@map("subscription_analytics")
  @@unique([date, planId])
  @@index([date])
  @@index([planId])
}

// ========================================
// PROMOTIONAL CODES AND DISCOUNTS
// ========================================

model PromoCode {
  id                  String   @id @default(cuid())
  code                String   @unique
  name                String?
  description         String?
  
  // Discount configuration
  discountType        DiscountType @map("discount_type")
  discountValue       Decimal      @db.Decimal(10,2) @map("discount_value")
  maxDiscountAmount   Decimal?     @db.Decimal(10,2) @map("max_discount_amount")
  
  // Validity period
  validFrom           DateTime     @map("valid_from")
  validUntil          DateTime?    @map("valid_until")
  
  // Usage limits
  maxUses             Int?         @map("max_uses")
  maxUsesPerCustomer  Int?         @map("max_uses_per_customer")
  currentUses         Int          @default(0) @map("current_uses")
  
  // Applicability
  applicablePlans     String[]     @map("applicable_plans") // Array of plan IDs
  firstTimeOnly       Boolean      @default(false) @map("first_time_only")
  
  // Status
  isActive            Boolean      @default(true) @map("is_active")
  
  // Stripe integration
  stripeCouponId      String?      @map("stripe_coupon_id")
  
  // Metadata
  metadata            Json         @default("{}")
  createdAt           DateTime     @default(now()) @map("created_at")
  updatedAt           DateTime     @updatedAt @map("updated_at")
  
  // Relationships
  usages              PromoCodeUsage[]
  
  @@map("promo_codes")
  @@index([code])
  @@index([validFrom, validUntil])
  @@index([isActive])
}

model PromoCodeUsage {
  id                  String   @id @default(cuid())
  promoCodeId         String   @map("promo_code_id")
  userId              String   @map("user_id")
  subscriptionId      String?  @map("subscription_id")
  
  // Usage details
  discountAmount      Decimal  @db.Decimal(10,2) @map("discount_amount")
  usedAt              DateTime @default(now()) @map("used_at")
  
  // Relationships
  promoCode           PromoCode @relation(fields: [promoCodeId], references: [id])
  
  @@map("promo_code_usage")
  @@unique([promoCodeId, userId])
  @@index([userId])
  @@index([usedAt])
}

// ========================================
// ENUMS
// ========================================

enum SubscriptionStatus {
  ACTIVE
  PAST_DUE
  CANCELED
  UNPAID
  INCOMPLETE
  INCOMPLETE_EXPIRED
  TRIALING
  PAUSED
}

enum BillingCycle {
  MONTHLY
  YEARLY
}

enum InvoiceStatus {
  PENDING
  PAID
  FAILED
  VOID
  REFUNDED
}

enum PaymentStatus {
  PENDING
  SUCCEEDED
  FAILED
  CANCELED
  REFUNDED
}

enum PaymentMethod {
  CARD
  BANK_TRANSFER
  PAYPAL
  APPLE_PAY
  GOOGLE_PAY
}

enum DiscountType {
  PERCENTAGE
  FIXED_AMOUNT
}